<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tutorial :: Nuvolaris</title>
    <link rel="canonical" href="https://nuvolaris.github.io/nuvolaris/0.3.0/tutorial/index.html">
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../assets/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://nuvolaris.github.io">Nuvolaris</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="nuvolaris" data-version="0.3.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Nuvolaris</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Welcome</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../whats-new.html">What&#8217;s New in Nuvolaris 0.3.0</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../installation/index.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/index-nuv.html">Download</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/index-config.html">Configure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/index-update.html">Update</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../installation/local.html">Local Install</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation/local-docker.html">Docker Desktop</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../installation/server.html">Server Install</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation/server-sshkey.html">Create SSH Key</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation/server-generic.html">Prepare Linux Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../installation/cluster.html">Cluster Install</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation/cluster-eks.html">Install on Amazon EKS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation/cluster-aks.html">Install on Azure AKS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation/cluster-gke.html">Install on Google GKE</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation/cluster-osh.html">Install on RedHat OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Tutorial</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../development/index.html">Developer Guide</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Nuvolaris</span>
    <span class="version">0.3.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Nuvolaris</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">0.3.0</a>
        </li>
        <li class="version">
          <a href="../../0.2.2/index.html">0.2.2</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Nuvolaris</a></li>
    <li><a href="index.html">Tutorial</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.3.0</button>
  <div class="version-menu">
    <a class="version is-current" href="index.html">0.3.0</a>
    <a class="version is-missing" href="../../0.2.2/index.html">0.2.2</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/nuvolaris/nuvolaris-documentation/edit/0.3.0/modules/tutorial/pages/index.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial walks you through developing a simple Nuvolaris application
using the Command Line Interface (CLI) and Javascript (but any supported language will do).</p>
</div>
<div class="paragraph">
<p>Its purpose is to showcase serverless development in action by creating a contact form for a website.
We will see the development process from start to finish, including the deploying of the platform and running the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="anchor" href="#_getting_started"></a>Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imagine we have a static website and need server logic to store contacts
and validate data. This would require a server, a database and
some code to glue it all together. With a serverless approach we can
just sprinkle little functions (that we call actions) on top of our static website and let Nuvolaris
take care of the rest. No more setting up VMs, backend web servers, databases, etc.</p>
</div>
<div class="sect2">
<h3 id="_nuvolaris_cli_nuv"><a class="anchor" href="#_nuvolaris_cli_nuv"></a>Nuvolaris CLI: Nuv</h3>
<div class="paragraph">
<p>Serverless development is mostly performed on the CLI, and Nuvolaris has
it&#8217;s own tool called "nuv". It&#8217;s a command line tool that allows you to
deploy (and interact with) the platform seamlessly to the cloud, locally and custom environments.</p>
</div>
<div class="paragraph">
<p>Nuv is cross-platform and can be installed on Windows, Linux and MacOS. You can find
it here: <a href="https://github.com/nuvolaris/nuv/releases">Nuv Releases</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_nuvolaris_locally"><a class="anchor" href="#_deploy_nuvolaris_locally"></a>Deploy Nuvolaris Locally</h3>
<div class="paragraph">
<p>To start using Nuvolaris we can easily setup a local deployment consisting of a Kubernetes cluster and Nuvolaris. This
will give us a ready to use serverless environment. We also want to enable an extra service: a Postgres database, because we will use it later. Let&#8217;s run in the terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv config enable --postgres</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it&#8217;s the first time you use the nuv tool, it will ask you to download the tasks. In this case just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -update</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then re-run the config command. This will enable the extra services.</p>
</div>
<div class="paragraph">
<p>Now just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv setup devcluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>And with just that (when it finishes), we have a serverless platform ready to use!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nuvolaris_first_steps"><a class="anchor" href="#_nuvolaris_first_steps"></a>Nuvolaris First Steps</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_create_the_contact_package"><a class="anchor" href="#_create_the_contact_package"></a>Create the Contact Package</h3>
<div class="paragraph">
<p>The nuv tool embeds <code>wsk</code> (the OpenWhisk CLI) so we can use it to interact with the platform the same way we would with vanilla OpenWhisk.
The first step we can make is to create a new package to hold our actions, furthermore we can bind to this package the database url, so the actions can directly access it!</p>
</div>
<div class="paragraph">
<p>Use the debug subcommand to see what&#8217;s going on and grab the "postgres_url" value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv debug config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the postgres url and now we can create a new package for the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk package create contact -p dbUri &lt;postgres_url&gt;
ok: created package contact</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actions under this package will be able to access the "dbUri" variable from the args!</p>
</div>
</div>
<div class="sect2">
<h3 id="_our_first_action_the_contact_form"><a class="anchor" href="#_our_first_action_the_contact_form"></a>Our First Action: the Contact Form</h3>
<div class="paragraph">
<p>In Nuvolaris, actions can just return html and they can even act as web pages. These are called "web actions".
Let&#8217;s create a simple action that returns the contact form html:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function main() {
    return {
        body: `&lt;html&gt;&lt;head&gt;
&lt;link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"
      rel="stylesheet" id="bootstrap-css"&gt;
&lt;/head&gt;&lt;body&gt;
 &lt;div id="container"&gt;
  &lt;div class="row"&gt;
   &lt;div class="col-md-8 col-md-offset-2"&gt;
    &lt;h4&gt;Get in Touch&lt;/h4&gt;
    &lt;form method="POST" action="submit"&gt;
     &lt;div class="form-group"&gt;
       &lt;input type="text" name="name"
        class="form-control" placeholder="Name"&gt;
     &lt;/div&gt;
     &lt;div class="form-group"&gt;
        &lt;input type="email" name="email"
         class="form-control" placeholder="E-mail"&gt;
     &lt;/div&gt;
     &lt;div class="form-group"&gt;
        &lt;input type="tel" name="phone"
         class="form-control" placeholder="Phone"&gt;
     &lt;/div&gt;
     &lt;div class="form-group"&gt;
        &lt;textarea  name="message" rows="3"
         class="form-control" placeholder="Message"
         &gt;&lt;/textarea&gt;
      &lt;/div&gt;
      &lt;button class="btn btn-default" type="submit" name="button"&gt;
        Send
      &lt;/button&gt;
    &lt;/form&gt;
   &lt;/div&gt;
  &lt;/div&gt;
 &lt;/div&gt;
&lt;/body&gt;&lt;/html&gt;`
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the action is just a function called <code>main</code> that returns an object and optionally can have an object in input (not used in this case).
Save the code in a file called <code>form.js</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s deploy it in the platform:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action create contact/form form.js --web true
ok: created action contact/form</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are uploading the action into Nuvolaris under <code>contact/form</code> where <code>contact</code> is the package name we just created and <code>form</code> the action name.
The <code>--web true</code> flag tells Nuvolaris that this action is a web action, so it will be accessible via http. To do that, we have to get its url which was
automatically associated to the action (the url might be different in your case):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action get contact/form --url
ok: got action contact/form
http://localhost:3233/api/v1/web/nuvolaris/contact/form</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s open the url in the browser!</p>
</div>
<div class="imageblock text-center unresolved">
<div class="content">
<img src="../images/form.png" alt="Form">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_form_validation_and_submission"><a class="anchor" href="#_form_validation_and_submission"></a>Form Validation and Submission</h3>
<div class="paragraph">
<p>Now that we have a contact form, we have to handle the submission. We can do that by adding a new action that will be called when the form is submitted. Let&#8217;s create a <code>submit.js</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function main(args) {
  let message = []
  let errors = []
  // TODO: Form Validation
  // TODO: Returning the Result
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This action is a bit more complex. It takes the input object (called args) which will contain the form data (accessible via <code>args.name</code>, <code>args.email</code>, etc.). With that we will do some validation and then return the result.</p>
</div>
<div class="sect3">
<h4 id="_form_validation"><a class="anchor" href="#_form_validation"></a>Form Validation</h4>
<div class="paragraph">
<p>Let&#8217;s start filling the "Form Validation" part by checking the name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// validate the name
if(args.name) {
 message.push("name: "+args.name)
} else {
 errors.push("No name provided")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the email by using a regular expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// validate the email
var re = /\S+@\S+\.\S+/;
if(args.email &amp;&amp; re.test(args.email)) {
   message.push("email: "+args.email)
} else {
  errors.push("Email missing or incorrect.")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The phone, by checking that it&#8217;s at least 10 digits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// validate the phone
if(args.phone &amp;&amp; args.phone.match(/\d/g).length &gt;= 10) {
  message.push("phone: "+args.phone)
} else {
  errors.push("Phone number missing or incorrect.")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally the message text, if present:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// validate the message
if(args.message) {
  message.push("message:" +args.message)
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_validation_done_return_the_result"><a class="anchor" href="#_validation_done_return_the_result"></a>Validation Done, Return the Result</h4>
<div class="paragraph">
<p>With the validation phase, we added to the "errors" array all the errors we found, and to the "message" array all the data we want to show to the user. So if there are errors, we have to show them, otherwise we store the message and return a "thank you" page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">if(errors.length) {
  var errs = "&lt;ul&gt;&lt;li&gt;"+errors.join("&lt;/li&gt;&lt;li&gt;")+"&lt;/li&gt;&lt;/ul&gt;"
  return {
    body: "&lt;h1&gt;Errors!&lt;/h1&gt;"+
      data + errs +
      '&lt;br&gt;&lt;a href="javascript:window.history.back()"&gt;Back&lt;/a&gt;'
   }
} else {
   var data = "&lt;pre&gt;"+message.join("\n")+"&lt;/pre&gt;"
   // storing in the database
   // TODO: &lt;Store the message in the database&gt;
   return {
     body: "&lt;h1&gt;Thank you!&lt;/h1&gt;"+ data
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is not yet complete, but let&#8217;s start deploying it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action create contact/submit submit.js --web true
ok: created action contact/submit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you go to the contact form page and submit it correctly, you should see the "Thank you" page.</p>
</div>
<div class="imageblock text-center unresolved">
<div class="content">
<img src="../images/submit.png" alt="Submit Result">
</div>
</div>
<div class="paragraph">
<p>Almost like magic, the submit action is automatically triggered by the form submit button with the right data.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_storing_the_message_in_the_database"><a class="anchor" href="#_storing_the_message_in_the_database"></a>Storing the Message in the Database</h3>
<div class="paragraph">
<p>Now we are ready to use the database that we enabled at the beginning of the tutorial.
Since we are using a relational database, we need to create a table to store the contact data. We can do that by creating a new action called <code>create-table.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { Client } = require('pg')

async function main(args) {
    const client = new Client({ connectionString: args.dbUri });

    const createTable = `
    CREATE TABLE IF NOT EXISTS contacts (
        id UUID PRIMARY KEY,
        name varchar(50),
        email varchar(50),
        phone varchar(50),
        message varchar(300)
    );
    `
    // Connect to database server
    await client.connect();

    try {
        await client.query(createTable)
    } catch (e) {
        console.log(e);
        throw e
    } finally {
        client.end();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We just need to run this once and it does not need to be a web action. We can deploy it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action create contact/create-table create-table.js
ok: created action contact/create-table</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action invoke contact/create-table -r
{}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we invoked the action manually with <code>-r</code> to get the result, which is an empty object because the action does not return anything.</p>
</div>
<div class="sect3">
<h4 id="_the_action_to_store_the_data"><a class="anchor" href="#_the_action_to_store_the_data"></a>The Action to Store the Data</h4>
<div class="paragraph">
<p>We could just write the code to insert data into the table in the <code>submit.js</code> action, but it&#8217;s better to have a separate action for that. Let&#8217;s create a new action called <code>write.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const { Client } = require('pg')

async function main(args) {
    const client = new Client({ connectionString: args.dbUri });

    // Connect to database server
    await client.connect();

    const { name, email, phone, message } = args

    try {
        await client.query(
            'INSERT INTO nuvolaris_table(name,email,phone,message) VALUES($1,$2,$3,$4)',
            [name, email, phone, message]
        )
    } catch (e) {
        console.log(e);
        throw e
    } finally {
        client.end();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Very similar to the create table action, but this time we are inserting data into the table by passing the values as parameters. Let&#8217;s deploy it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action create contact/write write.js
ok: created action contact/write</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finalizing_the_submit_action"><a class="anchor" href="#_finalizing_the_submit_action"></a>Finalizing the Submit Action</h3>
<div class="paragraph">
<p>Alright, we are almost done. We just need to add the code to invoke the <code>write</code> action to store the data. We can do that by adding a small function
inside the <code>submit.js</code> action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">var openwhisk = require('openwhisk')

function save(doc) {
  var ow = openwhisk({api_key: "25cdfc80-1e9f-4863-9162-42e8d6ae11c6:0ESe6byS0fD8xi93OIZGeIHFb0siACR1d6OtjLfEeLzEFaWJ8ArddHzsiII8MHMO"})
  return ow.actions.invoke({
    "name": "contact/write",
    "params": {
      "name": doc.name,
      "email": doc.email,
      "phone": doc.phone,
      "message": doc.message
    }
  })
}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add that above the <code>main</code> function! What we are doing here is to
import the special <code>openwhisk</code> module that gives you access to the Openwhisk
API (the Nuvolaris' serverless engine) from within any action. To construct
the <code>ow</code> object we need to pass the API key, which you can get with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk property get --auth
ok: whisk auth get</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the default user, the key should be the same as the one in the code above.</p>
</div>
<div class="paragraph">
<p>Now we can replace that last TODO with a call to the <code>save</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">save({
      "name": args.name,
      "email": args.email,
      "phone": args.phone,
      "message": args.message
    })</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s update the action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action update contact/submit submit.js --web true
ok: updated action contact/submit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the pipeline is complete, and we can test it by submitting the form again. This time the data will be stored in the database.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sending_an_email"><a class="anchor" href="#_sending_an_email"></a>Sending an Email</h3>
<div class="paragraph">
<p>Now let&#8217;s add a feature that shows how the system interacts with other systems. We will set up the system to send an email when someone uses our contact form (for both complete and incomplete submissions).</p>
</div>
<div class="paragraph">
<p>We are going to use the <a href="https://sendgrid.com">SendGrid</a> service to send the email.
First, we need to create a Sendgrid account and get an API key in the Settings&#8594;ApiKeys menu. Just go on the SendGrid homepage and follow the signup process, once you are in
you have to create a "Sender" account and finally go on the Api Keys page and create one.</p>
</div>
<div class="paragraph">
<p>Then we can proceed to create a new action called <code>send-email.js</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">async function main(args) {
    let res = await fetch("https://api.sendgrid.com/v3/mail/send", {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + args.sendgrid
        },
        body: JSON.stringify({
            "from": { "email": args.from },
            "subject": "[Contact Form]",
            "personalizations": [
                { "to": [{ "email": args.to }] }
            ],
            "content": [
                { "type": "text/plain", "value": args.body }
            ]
        })
    })
    return { body: { ok: res.ok } }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This action uses 4 parameters, the <code>args.sendgrid</code> which is the api key. The <code>args.from</code> and <code>args.to</code>, the sender and recipient, and finally <code>args.body</code> which is the content. This last one will be the body returned from the submit action.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first set up the action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">SENDGRID="&lt;put your api key&gt;"
FROM=&lt;your autorized sender&gt;
TO=&lt;your destitation&gt;

nuv -wsk action create contact/sendemail send-email.js -p sendgrid $SENDGRID -p from $FROM -p to $TO --web=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are already setting the first 3 parameters, the last one is given in input by
the submit action at every invocation.</p>
</div>
<div class="sect3">
<h4 id="_creating_the_action_sequence"><a class="anchor" href="#_creating_the_action_sequence"></a>Creating the Action Sequence</h4>
<div class="paragraph">
<p>We have developed an action that can send an email as a standalone action, but we designed it to take the output of the submit action and return it as is so we can create a pipeline of actions, where the output of a command is used as an input for another command.</p>
</div>
<div class="paragraph">
<p>Note that it will send emails for every submission, even for incorrect inputs, so we will know if someone is trying to use the form without providing all the information. But we will only store the fully validated data in the database.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create this pipeline, called a sequence, and then test it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action create contact/submit-sendemail --sequence contact/submit,contact/sendemail --web true
ok: created action contact/submit-sendemail</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now to start using this sequence, instead of just the submit action, we need to update the <code>form.js</code> action to invoke the new sequence:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">--- &lt;form method="POST" action="submit"&gt;
+++ &lt;form method="POST" action="submit-sendmail"&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv -wsk action update contact/form form.js --web true
ok: updated action contact/form</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now try to fill the form again and press send! It will execute the sequence and you will receive the email on your email account that you used
in sendgrid.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cleaning_up"><a class="anchor" href="#_cleaning_up"></a>Cleaning Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you are done experimenting and want to tear everything down, just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nuv setup devcluster --uninstall
nuv config disable --postgres</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will remove Nuvolaris and the local cluster, and disable the postgres database that we enabled earlier.</p>
</div>
<div class="paragraph">
<p>Checkout the other tutorials to learn how to build more complex applications with Nuvolaris!</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../assets/js/site.js" data-ui-root-path="../../../assets"></script>
<script async src="../../../assets/js/vendor/highlight.js"></script>
  </body>
</html>
